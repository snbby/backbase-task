# backbase-task
## General notes
**SQL lite** is used as DB for easier setup process.  
For production purposes better to use Postgres/smth else.

Tested with **Python3.11**
## Installation
You may want to create `virtualenv` before
```
git clone git@github.com:snbby/backbase-task.git
pip install -r requirements.txt
export CURRENCY_BEACON_API_KEY=<YOUR_API_KEY_HERE>
python manage.py migrate
python manage.py fill_init_data  # Populate DB with Providers and Currencies
```

## Launch
```
python manage.py createsuperuser  # To access Django admin
python manage.py runserver
```

Admin interface will be available at: http://localhost:8000/admin

## Tests
Internet queries are mocked in tests  
You can safely run tests with:
```
pytest
```

# Exchange rates API
## Currency rates list
Example query:
```
curl --location 'localhost:8000/api/v1/currency-rates/?source_currency=USD&date_from=2023-10-01&date_to=2023-10-10'
```

## Convert amount
Example query
```
curl --location 'localhost:8000/api/v1/convert-amount/?amount=100&source_currency=USD&exchanged_currency=GBP'
```


## Currency CRUD
```
curl --location 'localhost:8000/api/v1/currencies/'
```
**PUT, PATCH, POST, GET, DELETE** are also available, you can check Postman collection for queries


# Exchange Rate Evolution backoffice / admin
Currency converter interface is located here: http://localhost:8000/admin/my_currency/exchangecurrency/add/
You can enter `source_currency`, `exchanged_currency` and `source_amount` and then click Save.
The amount will be returned as django success message

# Async task to load historical data
Async task can be launched with the curl:
```
curl --location 'localhost:8000/api/v1/launch-history-task/' \
--form 'date_from="2024-01-10"' \
--form 'date_to="2024-10-11"' \
--form 'source_currency="USD"'
```

I used Threads in order to respond to the request immediately and set an async task.  
Then I divide the date period into chunks (by 30 days) and launch Thread for every chunk.  
Every thread then pulls data from Currency Beacon and saves data to the database.  

Production solution should involve Celery or Dramatiq for scheduling async tasks.  
Since they also need RabbitMQ/Redis for the queue, I decided that for this test it's enought to use Threads.  

Since we are doing I/O operations while requesting Currency Beacon API so we can benefit from using Threads.  
Django ORM doesn't support async connections, so I am using Bulk_Insert for speeding up this operation.  
Dividing this task into processes won't benefit because we have almost no CPU pressure in our task.  


# Provide historical data for the test
This test uses Fake data generated by Faker and Factory: [test_fill_db_with_fake_currency_exchanges](./my_currency/tests/test_app.py#L183)  
Here you can view factories: [factories.py](./my_currency/tests/factories.py)  
Here you can view several fixtures with loading data from .json: [conftest.py](./my_currency/tests/conftest.py#L21)


# API versioning/scope
Here you can see v1 and v2 currencies CRUD api handle: [urls.py](./my_currency/urls.py)  
They are the same, I just wanted to setup versioning.
For production versioning it might be better to organize separate `viewsets`, `serializers`, `controllers` into `v1` and `v2` folder under `my_currency` folder

# OpenAPI schema (for Postman)
Can be found here: http://localhost:8000/api/schema
The file can be uploaded then to Postman for testing purposes

# Post notes
There are a lot of things that might be done for production purposes, I will count them down:
1. Production service can be launched with **gunicorn** with `DEBUG=False`
2. Replace SQLLite with Postgres
3. Service should be dockerized
4. For historic async tasks better to use Celery/DramatiQ + RabbitMQ/Redis
5. Endpoints might be closed with Auth

Some thoughts about the task:
1. I didn't follow the exact signature `get_exchange_rate_data(source_currency, exchanged_currency, valuation_date, provider)` as it was described in the task. Since the provider options are not visible in the Viewset scope I hoped it would be admittable change.